<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>GIF to PGN via Canvas</title>
</head>
<body>
<h1>Конвертер GIF в PGN через Canvas</h1>
<input type="file" id="gifInput" accept=".gif">
<button onclick="processGIF()">Конвертировать</button>
<a id="downloadLink" style="display:none;">Скачать PGN</a>

<script src="https://cdn.jsdelivr.net/npm/gifuct-js/dist/gifuct.min.js"></script>
<script>
const files = "abcdefgh";
let array_images = [];

function p2c(x, y) {
    const file = files[x];
    const rank = 8 - y;
    return file + rank;
}

function generate_move(move) {
    switch(move % 4) {
        case 0: return `${Math.floor(move/2)+1}. Kb1`;
        case 1: return "Kb8";
        case 2: return `${Math.floor(move/2)+1}. Ka1`;
        case 3: return "Ka8";
    }
}

// Получаем HEX цвет пикселя через canvas
function hex(array_images, frame, x, y) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = array_images[frame].width;
    canvas.height = array_images[frame].height;
    ctx.drawImage(array_images[frame], 0, 0);
    const pixel = ctx.getImageData(x, y, 1, 1).data;
    const hexColor = `#${pixel[0].toString(16).padStart(2,'0')}${pixel[1].toString(16).padStart(2,'0')}${pixel[2].toString(16).padStart(2,'0')}`;
    return hexColor;
}

// Конвертация GIF в массив изображений
async function gif_to_array(file) {
    const arrayBuffer = await file.arrayBuffer();
    const gif = new window.GifuctJs.Gif(arrayBuffer);
    const frames = gif.decompressFrames(true);

    array_images = [];
    for (let f = 0; f < frames.length; f++) {
        const canvas = document.createElement('canvas');
        canvas.width = frames[f].dims.width;
        canvas.height = frames[f].dims.height;
        const ctx = canvas.getContext('2d');
        const imageData = ctx.createImageData(canvas.width, canvas.height);
        imageData.data.set(frames[f].patch);
        ctx.putImageData(imageData, 0, 0);

        const img = new Image();
        img.src = canvas.toDataURL();
        await new Promise(r => img.onload = r); // ждем загрузки изображения
        array_images.push(img);
    }
}

// Генерация PGN
function generate_pgn() {
    const highlights = [];
    for (let frame = 0; frame < array_images.length; frame++) {
        let frame_highlights = "{[%c_highlight ";
        for (let x = 0; x < 8; x++) {
            for (let y = 0; y < 8; y++) {
                const color = hex(array_images, frame, x, y);
                const square = p2c(x, y);
                frame_highlights += `${square};color;${color};opacity;1;square;${square};persistent;true,`;
            }
        }
        frame_highlights += "]}";
        highlights.push(frame_highlights);
    }

    let pgn = `[SetUp "1"]\n[FEN "k7/8/8/8/8/8/8/K7 w - - 0 1"]\n`;
    for (let move = 0; move < array_images.length; move++) {
        pgn += `${generate_move(move)} ${highlights[move]} `;
    }
    return pgn;
}

// Основная функция
async function processGIF() {
    const input = document.getElementById('gifInput');
    if (!input.files.length) {
        alert("Выберите GIF файл!");
        return;
    }
    const file = input.files[0];
    await gif_to_array(file);

    if (array_images[0].width !== 8 || array_images[0].height !== 8) {
        alert(`GIF размером ${array_images[0].width}x${array_images[0].height}, нужен 8x8`);
        return;
    }

    const pgn = generate_pgn();
    const blob = new Blob([pgn], {type: "text/plain;charset=utf-8"});
    const link = document.getElementById('downloadLink');
    link.href = URL.createObjectURL(blob);
    link.download = file.name.replace(/\.[^/.]+$/, "") + ".pgn";
    link.style.display = 'inline';
    link.textContent = "Скачать PGN";
}
</script>
</body>
</html>
