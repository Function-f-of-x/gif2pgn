<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>GIF → PGN конвертер (массив кадров)</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  #output { white-space: pre-wrap; background: #f0f0f0; padding: 10px; margin-top: 10px; }
</style>
</head>
<body>
<h1>GIF → PGN конвертер (8×8, массив кадров)</h1>
<input type="file" id="gifInput" accept="image/gif">
<button id="convertBtn">Конвертировать</button>
<pre id="output"></pre>
<a id="download" style="display:none;">Скачать PGN</a>
<canvas id="canvas" width="8" height="8" style="display:none;"></canvas>

<script src="https://cdn.jsdelivr.net/npm/gifuct-js/dist/gifuct.min.js"></script>
<script>
const files = "abcdefgh";
let array_images = [];

function p2c(x, y) {
  return files[x] + (8 - y);
}

function generateMove(move) {
  switch (move % 4) {
    case 0: return `${Math.floor(move/2)+1}. Kb1`;
    case 1: return "Kb8";
    case 2: return `${Math.floor(move/2)+1}. Ka1`;
    case 3: return "Ka8";
  }
}

// Получение HEX через canvas из массива изображений
function hex(array_images, frame, x, y) {
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  canvas.width = array_images[frame].width;
  canvas.height = array_images[frame].height;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(array_images[frame], 0, 0);
  const data = ctx.getImageData(x, y, 1, 1).data;
  return `#${data[0].toString(16).padStart(2,'0').toUpperCase()}${data[1].toString(16).padStart(2,'0').toUpperCase()}${data[2].toString(16).padStart(2,'0').toUpperCase()}`;
}

// Разбор GIF в массив изображений
async function gifToArray(file) {
  const buffer = await file.arrayBuffer();
  const gif = new window.GifuctJs.Gif(buffer);
  const frames = gif.decompressFrames(true);
  array_images = [];

  for (let f = 0; f < frames.length; f++) {
    const canvas = document.createElement('canvas');
    canvas.width = frames[f].dims.width;
    canvas.height = frames[f].dims.height;
    const ctx = canvas.getContext('2d');
    const imgData = ctx.createImageData(canvas.width, canvas.height);
    imgData.data.set(frames[f].patch);
    ctx.putImageData(imgData, 0, 0);

    const img = new Image();
    img.src = canvas.toDataURL();
    await new Promise(r => img.onload = r);
    array_images.push(img);
  }
}

document.getElementById("convertBtn").onclick = async function() {
  const file = document.getElementById("gifInput").files[0];
  if (!file) { alert("Выберите GIF!"); return; }

  await gifToArray(file);

  if (array_images[0].width !== 8 || array_images[0].height !== 8) {
    alert(`GIF имеет размер ${array_images[0].width}x${array_images[0].height}, нужен 8x8`);
    return;
  }

  let highlights = [];
  for (let f = 0; f < array_images.length; f++) {
    let frame_highlights = "{[%c_highlight ";
    for (let y = 0; y < 8; y++) {
      for (let x = 0; x < 8; x++) {
        const color = hex(array_images, f, x, y);
        const square = p2c(x, y);
        frame_highlights += `${square};color;${color};opacity;1;square;${square};persistent;true,`;
      }
    }
    frame_highlights += "]}";
    highlights.push(frame_highlights);
  }

  let pgn = '[SetUp "1"]\n[FEN "k7/8/8/8/8/8/8/K7 w - - 0 1"]\n';
  for (let m = 0; m < highlights.length; m++) {
    pgn += `${generateMove(m)} ${highlights[m]} `;
  }

  document.getElementById("output").textContent = pgn;

  const blob = new Blob([pgn], {type: "text/plain"});
  const link = document.getElementById("download");
  link.href = URL.createObjectURL(blob);
  link.download = file.name.replace(/\.gif$/i, ".pgn");
  link.textContent = "Скачать PGN";
  link.style.display = "inline";
};
</script>
</body>
</html>
