<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>GIF → PGN конвертер</title>
</head>
<body>
<h1>GIF → PGN конвертер</h1>
<input type="file" id="gifInput" accept="image/gif">
<button id="convertBtn">Конвертировать</button>
<pre id="output"></pre>
<a id="download" style="display:none;">Скачать PGN</a>

<script type="module">
import { parseGIF, decompressFrames } from 'https://cdn.jsdelivr.net/npm/gifuct-js@2.0.2/dist/gifuct.esm.js';

function p2c(x, y) {
  const files = "abcdefgh";
  return files[x] + (8 - y);
}

function generateMove(move) {
  switch (move % 4) {
    case 0: return `${Math.floor(move/2)+1}. Kb1`;
    case 1: return "Kb8";
    case 2: return `${Math.floor(move/2)+1}. Ka1`;
    case 3: return "Ka8";
  }
}

document.getElementById("convertBtn").onclick = async () => {
  const file = document.getElementById("gifInput").files[0];
  if (!file) { alert("Выберите GIF!"); return; }

  const buf = await file.arrayBuffer();
  const gif = parseGIF(buf);
  const frames = decompressFrames(gif, true);

  if (frames[0].dims.width !== 8 || frames[0].dims.height !== 8) {
    alert(`GIF имеет размер ${frames[0].dims.width}x${frames[0].dims.height}, нужен 8x8`);
    return;
  }

  let highlights = [];
  for (let f = 0; f < frames.length; f++) {
    const frame = frames[f];
    const frame_highlights = [];
    const pixels = frame.patch;

    let str = "{[%c_highlight ";
    for (let y = 0; y < 8; y++) {
      for (let x = 0; x < 8; x++) {
        const idx = (y*8 + x)*4;
        const r = pixels[idx], g = pixels[idx+1], b = pixels[idx+2];
        const hex = `#${r.toString(16).padStart(2,"0").toUpperCase()}${g.toString(16).padStart(2,"0").toUpperCase()}${b.toString(16).padStart(2,"0").toUpperCase()}`;
        str += `${p2c(x,y)};color;${hex};opacity;1;square;${p2c(x,y)};persistent;true,`;
      }
    }
    str += "]}";
    highlights.push(str);
  }

  let pgn = '[SetUp "1"]\n[FEN "k7/8/8/8/8/8/8/K7 w - - 0 1"]\n';
  for (let m = 0; m < frames.length; m++) {
    pgn += `${generateMove(m)} ${highlights[m]} `;
  }

  document.getElementById("output").textContent = pgn;

  const blob = new Blob([pgn], {type: "text/plain"});
  const url = URL.createObjectURL(blob);
  const link = document.getElementById("download");
  link.href = url;
  link.download = file.name.replace(/\.gif$/i, ".pgn");
  link.textContent = "Скачать PGN";
  link.style.display = "inline";
};
</script>
</body>
</html>
